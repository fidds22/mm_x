name: Release Workflow

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  # Create Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Generate changelog
        run: |
          echo "ðŸ“ Generating changelog..."
          echo "## Changes in ${{ github.ref_name }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸŽ¨ Artistic Portfolio Updates" >> CHANGELOG.md
          echo "- Enhanced visual effects and animations" >> CHANGELOG.md
          echo "- Improved responsive design" >> CHANGELOG.md
          echo "- Updated exhibition content" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ðŸ› ï¸ Technical Improvements" >> CHANGELOG.md
          echo "- Performance optimizations" >> CHANGELOG.md
          echo "- Code quality improvements" >> CHANGELOG.md
          echo "- Documentation updates" >> CHANGELOG.md

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: 'Manoela Madera Art Portfolio ${{ github.ref_name }}'
          body: |
            ## ðŸŽ¨ Manoela Madera Art Exhibition Portfolio
            
            ### ðŸš€ What's New
            - Enhanced artistic portfolio with modern design
            - Improved animations and visual effects
            - Better mobile responsiveness
            - Updated exhibition content and information
            
            ### ðŸ› ï¸ Technical Updates
            - Performance optimizations
            - Code quality improvements
            - Documentation enhancements
            - Security updates
            
            ### ðŸ“± Features
            - Responsive design for all devices
            - Smooth animations with GSAP
            - Modern glass morphism effects
            - Paint drip transitions
            - Interactive navigation
            
            ### ðŸŽ¯ Exhibition Details
            - Artist: Manoela Madera
            - Opening: Thursday, October 24 at 7:00 PM
            - Venue: Instituto de Subcultura
            - Theme: Color and form as languages in movement
            
            ---
            
            **Full changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
          draft: false
          prerelease: false

  # Build and Deploy
  build-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Notify deployment
        run: |
          echo "ðŸš€ Release ${{ github.ref_name }} deployed successfully!"
          echo "ðŸŒ Production URL: https://your-domain.vercel.app"

  # Update Documentation
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update version in documentation
        run: |
          echo "ðŸ“ Updating documentation with new version..."
          
          # Update PROJECT_CONTEXT.md with new version
          if [ -f "PROJECT_CONTEXT.md" ]; then
            sed -i "s/Last Updated:.*/Last Updated: $(date '+%B %d, %Y, %I:%M %p')/" PROJECT_CONTEXT.md
            echo "âœ… Updated PROJECT_CONTEXT.md"
          fi
          
          # Update TECH_STACK.md with new version
          if [ -f "TECH_STACK.md" ]; then
            sed -i "s/Last Updated:.*/Last Updated: $(date '+%B %d, %Y, %I:%M %p')/" TECH_STACK.md
            echo "âœ… Updated TECH_STACK.md"
          fi

      - name: Commit documentation updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add PROJECT_CONTEXT.md TECH_STACK.md
          git commit -m "docs: update documentation for release ${{ github.ref_name }}" || echo "No changes to commit"
          git push

  # Create Release Notes
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    needs: [create-release, build-deploy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate release notes
        run: |
          echo "ðŸ“‹ Generating release notes for ${{ github.ref_name }}..."
          
          cat > RELEASE_NOTES.md << EOF
          # ðŸŽ¨ Manoela Madera Art Portfolio - ${{ github.ref_name }}
          
          ## ðŸš€ Release Highlights
          
          ### ðŸŽ¨ Artistic Features
          - Enhanced visual effects and animations
          - Improved paint drip transitions
          - Better color palette integration
          - Updated exhibition content
          
          ### ðŸ› ï¸ Technical Improvements
          - Performance optimizations
          - Code quality improvements
          - Security updates
          - Documentation enhancements
          
          ### ðŸ“± User Experience
          - Better mobile responsiveness
          - Improved navigation
          - Enhanced accessibility
          - Faster loading times
          
          ## ðŸ”§ Technical Details
          
          ### Dependencies Updated
          - Next.js: Latest stable version
          - GSAP: Latest animation library
          - Tailwind CSS: Latest styling framework
          
          ### Performance Improvements
          - Reduced bundle size
          - Optimized animations
          - Better image loading
          - Improved caching
          
          ## ðŸŽ¯ Exhibition Information
          
          - **Artist**: Manoela Madera
          - **Opening**: Thursday, October 24 at 7:00 PM
          - **Venue**: Instituto de Subcultura
          - **Theme**: Color and form as languages in movement
          
          ## ðŸ“š Documentation
          
          All documentation has been updated to reflect the latest changes:
          - PROJECT_CONTEXT.md
          - TECH_STACK.md
          - COMPONENT_ARCHITECTURE.md
          - DEVELOPMENT_GUIDELINES.md
          - ARTISTIC_CONTENT.md
          - DEPLOYMENT_GUIDE.md
          - PROJECT_GUIDELINES.md
          
          ## ðŸš€ Deployment
          
          The release has been automatically deployed to production.
          - **Production URL**: https://your-domain.vercel.app
          - **Staging URL**: https://your-domain-staging.vercel.app
          
          ## ðŸ”„ Next Steps
          
          - Monitor production performance
          - Collect user feedback
          - Plan next feature updates
          - Continue artistic content development
          
          ---
          
          **Release Date**: $(date '+%B %d, %Y')
          **Version**: ${{ github.ref_name }}
          **Author**: Fidel Viera
          EOF
          
          echo "âœ… Release notes generated"

      - name: Upload release notes
        uses: actions/upload-artifact@v3
        with:
          name: release-notes-${{ github.ref_name }}
          path: RELEASE_NOTES.md

  # Final Status
  release-status:
    name: Release Status
    runs-on: ubuntu-latest
    needs: [create-release, build-deploy, update-docs, release-notes]
    if: always()
    steps:
      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release ${{ github.ref_name }} Summary:"
          echo "âœ… Release created: ${{ needs.create-release.result }}"
          echo "âœ… Build and deploy: ${{ needs.build-deploy.result }}"
          echo "âœ… Documentation updated: ${{ needs.update-docs.result }}"
          echo "âœ… Release notes generated: ${{ needs.release-notes.result }}"
          
          if [ "${{ needs.create-release.result }}" == "success" ] && 
             [ "${{ needs.build-deploy.result }}" == "success" ]; then
            echo "ðŸš€ Release ${{ github.ref_name }} completed successfully!"
          else
            echo "âŒ Some release steps failed"
            exit 1
          fi
